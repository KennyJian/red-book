<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°çº¢ä¹¦æ•°æ®çˆ¬å–ç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .content {
            padding: 30px;
        }

        .section {
            margin-bottom: 30px;
            padding: 25px;
            background: #f8f9fa;
            border-radius: 12px;
        }

        .section h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 20px;
            border-left: 4px solid #ff6b6b;
            padding-left: 15px;
        }

        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .input-group input {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .input-group input:focus {
            outline: none;
            border-color: #ff6b6b;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }

        .btn-primary {
            background: #ff6b6b;
            color: white;
        }

        .btn-primary:hover {
            background: #ee5a6f;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 107, 107, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
            padding: 6px 12px;
            font-size: 12px;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .keywords-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }

        .keyword-tag {
            background: white;
            padding: 8px 15px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .keyword-tag span {
            color: #333;
        }

        .status-panel {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #e0e0e0;
        }

        .status-item:last-child {
            border-bottom: none;
        }

        .status-label {
            color: #666;
            font-size: 14px;
        }

        .status-value {
            color: #333;
            font-weight: 500;
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
            margin: 15px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff6b6b 0%, #ee5a6f 100%);
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: 500;
        }

        .users-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 12px;
            overflow: hidden;
        }

        .users-table th {
            background: #ff6b6b;
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 500;
        }

        .users-table td {
            padding: 15px;
            border-bottom: 1px solid #e0e0e0;
        }

        .users-table tr:hover {
            background: #f8f9fa;
        }

        .users-table .desc-cell {
            max-width: 280px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .user-link {
            color: #ff6b6b;
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s;
        }

        .user-link:hover {
            color: #ee5a6f;
            text-decoration: underline;
        }

        .user-link:visited {
            color: #ff6b6b;
        }

        .comment-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            overflow-y: auto;
        }

        .comment-modal-content {
            background: white;
            margin: 50px auto;
            padding: 30px;
            border-radius: 20px;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .comment-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e0e0e0;
        }

        .comment-modal-header h3 {
            margin: 0;
            color: #333;
        }

        .close-btn {
            background: #ff6b6b;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
        }

        .close-btn:hover {
            background: #ee5a6f;
        }

        .comment-item {
            padding: 15px;
            margin-bottom: 15px;
            background: #f8f9fa;
            border-radius: 12px;
            border-left: 4px solid #ff6b6b;
        }

        .comment-content {
            color: #333;
            line-height: 1.6;
            margin-bottom: 10px;
        }

        .comment-meta {
            font-size: 12px;
            color: #999;
            display: flex;
            gap: 15px;
        }

        .view-comments-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
        }

        .view-comments-btn:hover {
            background: #5a6268;
        }

        .users-table tr:last-child td {
            border-bottom: none;
        }

        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #fff;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“š å°çº¢ä¹¦æ•°æ®çˆ¬å–ç³»ç»Ÿ</h1>
            <p>é…ç½®å…³é”®è¯ï¼Œè‡ªåŠ¨çˆ¬å–ç”¨æˆ·ä¿¡æ¯</p>
        </div>

        <div class="content">
            <!-- å…³é”®è¯é…ç½®åŒºåŸŸ -->
            <div class="section">
                <h2>å…³é”®è¯é…ç½®</h2>
                <div class="input-group">
                    <input type="text" id="keywordInput" placeholder="è¾“å…¥å…³é”®è¯ï¼Œä¾‹å¦‚ï¼šç¾é£Ÿã€æ—…è¡Œã€ç©¿æ­...">
                    <button class="btn btn-primary" onclick="addKeyword()">æ·»åŠ å…³é”®è¯</button>
                </div>
                <div class="keywords-list" id="keywordsList"></div>
            </div>

            <!-- çˆ¬å–é…ç½®åŒºåŸŸ -->
            <div class="section">
                <h2>çˆ¬å–é…ç½®</h2>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px;">
                    <div>
                        <label style="display: block; margin-bottom: 8px; color: #666; font-size: 14px;">æœ€å¤šæŠ“å–å¸–å­æ•°</label>
                        <input type="number" id="maxNotes" value="100" min="1" max="500" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 8px; color: #666; font-size: 14px;">æ¯ä¸ªå¸–å­æœ€å¤šè¯„è®ºæ•°</label>
                        <input type="number" id="maxComments" value="100" min="1" max="500" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                    </div>
                </div>
                <div>
                    <label style="display: block; margin-bottom: 8px; color: #666; font-size: 14px;">è¯„è®ºè¿‡æ»¤å…³é”®è¯ï¼ˆå¤šä¸ªå…³é”®è¯ç”¨é€—å·åˆ†éš”ï¼Œç•™ç©ºä¸è¿‡æ»¤ï¼‰</label>
                    <div class="input-group">
                        <input type="text" id="commentFilterKeywords" placeholder="ä¾‹å¦‚ï¼šä¾¿å®œ,ä¼˜æƒ ,æ‰“æŠ˜">
                    </div>
                    <div style="margin-top: 10px; font-size: 12px; color: #999;">
                        æç¤ºï¼šåªæœ‰åŒ…å«è¿™äº›å…³é”®è¯çš„è¯„è®ºæ‰ä¼šè¢«é‡‡é›†
                    </div>
                </div>
            </div>

            <!-- çˆ¬å–æ§åˆ¶åŒºåŸŸ -->
            <div class="section">
                <h2>çˆ¬å–æ§åˆ¶</h2>
                <div class="status-panel">
                    <div class="status-item">
                        <span class="status-label">è¿è¡ŒçŠ¶æ€</span>
                        <span class="status-value" id="runningStatus">æœªè¿è¡Œ</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">å½“å‰å…³é”®è¯</span>
                        <span class="status-value" id="currentKeyword">-</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">å·²è·å–ç”¨æˆ·æ•°</span>
                        <span class="status-value" id="totalUsers">0</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">çŠ¶æ€ä¿¡æ¯</span>
                        <span class="status-value" id="statusMessage">ç­‰å¾…å¼€å§‹</span>
                    </div>
                    <div class="progress-bar" id="progressBar" style="display: none;">
                        <div class="progress-fill" id="progressFill" style="width: 0%">0%</div>
                    </div>
                </div>
                <button class="btn btn-primary" id="startBtn" onclick="startCrawl()">å¼€å§‹çˆ¬å–</button>
            </div>

            <!-- ç”¨æˆ·æ•°æ®å±•ç¤ºåŒºåŸŸ -->
            <div class="section">
                <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 8px;">
                    <h2 style="margin: 0;">ç”¨æˆ·æ•°æ® (<span id="userCount">0</span>)</h2>
                    <button type="button" class="btn btn-primary" id="exportExcelBtn" onclick="exportExcel()">å¯¼å‡º Excel</button>
                </div>
                <div style="overflow-x: auto;">
                    <table class="users-table">
                        <thead>
                            <tr>
                                <th>å¤´åƒ</th>
                                <th>ç”¨æˆ·ID</th>
                                <th>æ˜µç§°</th>
                                <th>ä¸»é¡µç®€ä»‹</th>
                                <th>è¯„è®ºæ•°</th>
                                <th>æ¥æºå…³é”®è¯</th>
                                <th>çˆ¬å–æ—¶é—´</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody">
                            <tr>
                                <td colspan="7" class="empty-state">æš‚æ— æ•°æ®</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- è¯„è®ºå¼¹çª— -->
    <div id="commentModal" class="comment-modal">
        <div class="comment-modal-content" id="commentModalContent">
        </div>
    </div>

    <script>
        const API_BASE = '/api';

        // å¯¼å‡ºç”¨æˆ·æ•°æ®ä¸º Excel
        async function exportExcel() {
            try {
                const res = await fetch(`${API_BASE}/users/export/excel`);
                if (!res.ok) {
                    const data = await res.json().catch(() => ({}));
                    alert(data.error || 'å¯¼å‡ºå¤±è´¥');
                    return;
                }
                const blob = await res.blob();
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                var cd = res.headers.get('Content-Disposition');
var match = cd && cd.match(/filename\*?=(?:UTF-8'')?([^;\n]+)/);
a.download = (match ? decodeURIComponent(match[1].trim()) : null) || ('ç”¨æˆ·æ•°æ®_' + new Date().toISOString().slice(0,19).replace(/-/g,'').replace('T','_').replace(/:/g,'') + '.xlsx');
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            } catch (e) {
                console.error('exportExcel:', e);
                alert('å¯¼å‡ºå¤±è´¥');
            }
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.onload = function() {
            loadKeywords();
            loadUsers();
            loadStatus();
            // æ¯3ç§’æ›´æ–°ä¸€æ¬¡çŠ¶æ€
            setInterval(loadStatus, 3000);
            setInterval(loadUsers, 5000);
        };

        // åŠ è½½å…³é”®è¯åˆ—è¡¨
        async function loadKeywords() {
            try {
                const response = await fetch(`${API_BASE}/keywords`);
                const keywords = await response.json();
                renderKeywords(keywords);
            } catch (error) {
                console.error('åŠ è½½å…³é”®è¯å¤±è´¥:', error);
            }
        }

        // æ¸²æŸ“å…³é”®è¯åˆ—è¡¨
        function renderKeywords(keywords) {
            const container = document.getElementById('keywordsList');
            if (keywords.length === 0) {
                container.innerHTML = '<div class="empty-state">æš‚æ— å…³é”®è¯ï¼Œè¯·æ·»åŠ </div>';
                return;
            }
            container.innerHTML = keywords.map(keyword => `
                <div class="keyword-tag">
                    <span>${keyword}</span>
                    <button class="btn btn-danger" onclick="deleteKeyword('${keyword}')">Ã—</button>
                </div>
            `).join('');
        }

        // æ·»åŠ å…³é”®è¯
        async function addKeyword() {
            const input = document.getElementById('keywordInput');
            const keyword = input.value.trim();
            
            if (!keyword) {
                alert('è¯·è¾“å…¥å…³é”®è¯');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/keywords`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ keyword })
                });

                if (response.ok) {
                    input.value = '';
                    loadKeywords();
                } else {
                    const data = await response.json();
                    alert(data.error || 'æ·»åŠ å¤±è´¥');
                }
            } catch (error) {
                console.error('æ·»åŠ å…³é”®è¯å¤±è´¥:', error);
                alert('æ·»åŠ å…³é”®è¯å¤±è´¥');
            }
        }

        // åˆ é™¤å…³é”®è¯
        async function deleteKeyword(keyword) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤å…³é”®è¯ "${keyword}" å—ï¼Ÿ`)) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/keywords/${encodeURIComponent(keyword)}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    loadKeywords();
                }
            } catch (error) {
                console.error('åˆ é™¤å…³é”®è¯å¤±è´¥:', error);
            }
        }

        // å¼€å§‹çˆ¬å–
        async function startCrawl() {
            try {
                const response = await fetch(`${API_BASE}/keywords`);
                const keywords = await response.json();

                if (keywords.length === 0) {
                    alert('è¯·å…ˆæ·»åŠ å…³é”®è¯');
                    return;
                }

                // è·å–é…ç½®å‚æ•°
                const maxNotes = parseInt(document.getElementById('maxNotes').value) || 100;
                const maxComments = parseInt(document.getElementById('maxComments').value) || 100;
                const filterKeywordsText = document.getElementById('commentFilterKeywords').value.trim();
                const commentFilterKeywords = filterKeywordsText ? 
                    filterKeywordsText.split(',').map(k => k.trim()).filter(k => k) : [];

                const configText = `é…ç½®ä¿¡æ¯ï¼š
- å…³é”®è¯æ•°é‡: ${keywords.length}
- æœ€å¤šæŠ“å–å¸–å­æ•°: ${maxNotes}
- æ¯ä¸ªå¸–å­æœ€å¤šè¯„è®ºæ•°: ${maxComments}
- è¯„è®ºè¿‡æ»¤å…³é”®è¯: ${commentFilterKeywords.length > 0 ? commentFilterKeywords.join(', ') : 'æ— '}

ç¡®å®šè¦å¼€å§‹çˆ¬å–å—ï¼Ÿ`;

                if (!confirm(configText)) {
                    return;
                }

                const crawlResponse = await fetch(`${API_BASE}/crawl`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        keywords,
                        max_notes: maxNotes,
                        max_comments: maxComments,
                        comment_filter_keywords: commentFilterKeywords
                    })
                });

                if (crawlResponse.ok) {
                    alert('çˆ¬è™«å·²å¯åŠ¨ï¼Œè¯·æŸ¥çœ‹çŠ¶æ€é¢æ¿');
                    loadStatus();
                } else {
                    const data = await crawlResponse.json();
                    alert(data.error || 'å¯åŠ¨å¤±è´¥');
                }
            } catch (error) {
                console.error('å¯åŠ¨çˆ¬è™«å¤±è´¥:', error);
                alert('å¯åŠ¨çˆ¬è™«å¤±è´¥');
            }
        }

        // åŠ è½½çŠ¶æ€
        async function loadStatus() {
            try {
                const response = await fetch(`${API_BASE}/status`);
                const status = await response.json();

                document.getElementById('runningStatus').textContent = 
                    status.running ? '<span class="loading"></span> è¿è¡Œä¸­' : 'æœªè¿è¡Œ';
                document.getElementById('currentKeyword').textContent = 
                    status.current_keyword || '-';
                document.getElementById('totalUsers').textContent = status.total_users || 0;
                document.getElementById('statusMessage').textContent = status.message || 'ç­‰å¾…å¼€å§‹';

                const progressBar = document.getElementById('progressBar');
                const progressFill = document.getElementById('progressFill');
                const startBtn = document.getElementById('startBtn');

                if (status.running) {
                    progressBar.style.display = 'block';
                    progressFill.style.width = `${status.progress || 0}%`;
                    progressFill.textContent = `${status.progress || 0}%`;
                    startBtn.disabled = true;
                    startBtn.textContent = 'çˆ¬å–ä¸­...';
                } else {
                    progressBar.style.display = 'none';
                    startBtn.disabled = false;
                    startBtn.textContent = 'å¼€å§‹çˆ¬å–';
                }
            } catch (error) {
                console.error('åŠ è½½çŠ¶æ€å¤±è´¥:', error);
            }
        }

        // åŠ è½½ç”¨æˆ·æ•°æ®
        async function loadUsers() {
            try {
                const response = await fetch(`${API_BASE}/users`);
                const users = await response.json();

                document.getElementById('userCount').textContent = users.length;
                renderUsers(users);
            } catch (error) {
                console.error('åŠ è½½ç”¨æˆ·æ•°æ®å¤±è´¥:', error);
            }
        }

        // æ¸²æŸ“ç”¨æˆ·è¡¨æ ¼
        function renderUsers(users) {
            const tbody = document.getElementById('usersTableBody');
            
            if (users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="empty-state">æš‚æ— æ•°æ®</td></tr>';
                return;
            }

            tbody.innerHTML = users.map(user => {
                const userUrl = user.user_url || (user.user_id ? `https://www.xiaohongshu.com/user/profile/${user.user_id}?xsec_source=pc_note` : '#');
                const userId = user.user_id || '-';
                const nickname = user.nickname || '-';
                const desc = user.desc || user.user_desc || '';
                const comments = user.comments || [];
                const commentCount = comments.length;
                
                return `
                <tr>
                    <td>
                        ${user.avatar ? 
                            `<img src="${user.avatar}" alt="å¤´åƒ" class="avatar" onerror="this.style.display='none'">` : 
                            '<span style="color: #999;">-</span>'
                        }
                    </td>
                    <td>
                        ${userId !== '-' && userUrl !== '#' ? 
                            `<a href="${userUrl}" class="user-link" target="_blank" rel="noopener noreferrer">${userId}</a>` : 
                            userId
                        }
                    </td>
                    <td>
                        ${nickname !== '-' && userUrl !== '#' ? 
                            `<a href="${userUrl}" class="user-link" target="_blank" rel="noopener noreferrer">${nickname}</a>` : 
                            nickname
                        }
                    </td>
                    <td class="desc-cell" title="${escapeHtml(desc)}">${desc ? escapeHtml(desc) : '<span style="color: #999;">-</span>'}</td>
                    <td>${commentCount}</td>
                    <td>${user.keyword || user.source_keyword || '-'}</td>
                    <td>${user.crawl_time ? new Date(user.crawl_time).toLocaleString('zh-CN') : '-'}</td>
                    <td>
                        ${commentCount > 0 ? 
                            `<button class="view-comments-btn" onclick="showComments('${userId}')">æŸ¥çœ‹è¯„è®º</button>` : 
                            '-'
                        }
                    </td>
                </tr>
            `;
            }).join('');
        }

        // æ˜¾ç¤ºè¯„è®º
        function showComments(userId) {
            // ä»ç”¨æˆ·æ•°æ®ä¸­æŸ¥æ‰¾è¯„è®º
            fetch(`${API_BASE}/users`)
                .then(response => response.json())
                .then(users => {
                    const user = users.find(u => u.user_id === userId);
                    if (!user || !user.comments || user.comments.length === 0) {
                        alert('è¯¥ç”¨æˆ·æš‚æ— è¯„è®ºæ•°æ®');
                        return;
                    }

                    const modal = document.getElementById('commentModal');
                    const modalContent = document.getElementById('commentModalContent');
                    
                    modalContent.innerHTML = `
                        <div class="comment-modal-header">
                            <h3>${user.nickname || user.user_id} çš„è¯„è®º (${user.comments.length}æ¡)</h3>
                            <button class="close-btn" onclick="closeCommentModal()">å…³é—­</button>
                        </div>
                        <div>
                            ${user.comments.map(comment => {
                                const base = comment.note_id ? ('https://www.xiaohongshu.com/explore/' + comment.note_id) : '';
                                const token = comment.note_xsec_token || '';
                                const source = comment.note_xsec_source || '';
                                const noteUrl = base ? (token ? base + '?xsec_token=' + encodeURIComponent(token) + '&xsec_source=' + encodeURIComponent(source) : base) : '';
                                const noteTitle = comment.note_title || comment.note_id || 'æœªçŸ¥';
                                return `
                                <div class="comment-item">
                                    <div class="comment-content">${escapeHtml(comment.content || '')}</div>
                                    <div class="comment-meta">
                                        <span><strong>è¯„è®ºæ—¶é—´:</strong> ${comment.comment_time_str || (comment.comment_time ? formatCommentTime(comment.comment_time) : '-')}</span>
                                        <span>ç¬”è®°: ${noteUrl ? `<a href="${noteUrl}" class="user-link" target="_blank" rel="noopener noreferrer">${escapeHtml(noteTitle)}</a>` : noteTitle}</span>
                                        <span>å…³é”®è¯: ${comment.keyword || '-'}</span>
                                        <span>æŠ“å–æ—¶é—´: ${comment.crawl_time ? new Date(comment.crawl_time).toLocaleString('zh-CN') : '-'}</span>
                                        ${noteUrl ? `<span><a href="${noteUrl}" class="btn view-comments-btn" style="margin-left:8px" target="_blank" rel="noopener noreferrer">æŸ¥çœ‹åŸå¸–</a></span>` : ''}
                                    </div>
                                </div>
                            `}).join('')}
                        </div>
                    `;
                    
                    modal.style.display = 'block';
                })
                .catch(error => {
                    console.error('åŠ è½½è¯„è®ºå¤±è´¥:', error);
                    alert('åŠ è½½è¯„è®ºå¤±è´¥');
                });
        }

        // å…³é—­è¯„è®ºå¼¹çª—
        function closeCommentModal() {
            document.getElementById('commentModal').style.display = 'none';
        }

        // HTMLè½¬ä¹‰
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // è¯„è®ºæ—¶é—´æˆ³è½¬å¯è¯»æ—¶é—´ï¼ˆæ”¯æŒç§’æˆ–æ¯«ç§’ï¼‰
        function formatCommentTime(ts) {
            if (!ts) return '-';
            const ms = ts < 1e12 ? ts * 1000 : ts;
            return new Date(ms).toLocaleString('zh-CN');
        }

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        window.onclick = function(event) {
            const modal = document.getElementById('commentModal');
            if (event.target === modal) {
                closeCommentModal();
            }
        }

        // å›è½¦æ·»åŠ å…³é”®è¯
        document.getElementById('keywordInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                addKeyword();
            }
        });
    </script>
</body>
</html>
